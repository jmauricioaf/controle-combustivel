<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Consumo de Combustível</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }
        .container {
            max-width: 960px;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1); /* Makes the calendar icon visible on dark background */
        }
        /* Custom styles for action buttons */
        .action-button {
            @apply px-3 py-1 rounded-lg text-white font-semibold text-sm transition duration-300 ease-in-out shadow-sm;
        }
        .edit-button {
            @apply bg-yellow-500 hover:bg-yellow-600;
        }
        .delete-button {
            @apply bg-red-500 hover:bg-red-600;
        }
    </style>
</head>
<body class="p-4">
    <div class="container mx-auto bg-white shadow-lg rounded-xl p-6 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Registro de Consumo de Combustível</h1>

        <!-- Form Section -->
        <div class="mb-8 p-6 bg-blue-50 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold text-blue-800 mb-4">Adicionar Novo Abastecimento</h2>
            <form id="fuelForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="date" class="block text-gray-700 text-sm font-bold mb-2">Data:</label>
                    <input type="date" id="date" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                </div>
                <div>
                    <label for="odometer" class="block text-gray-700 text-sm font-bold mb-2">Hodômetro (km):</label>
                    <input type="number" id="odometer" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Ex: 12345" min="0" required>
                </div>
                <div>
                    <label for="liters" class="block text-gray-700 text-sm font-bold mb-2">Litros Abastecidos:</label>
                    <input type="number" id="liters" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400" step="0.01" placeholder="Ex: 45.50" min="0.01" required>
                </div>
                <div>
                    <label for="price" class="block text-gray-700 text-sm font-bold mb-2">Preço por Litro (R$):</label>
                    <input type="number" id="price" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400" step="0.01" placeholder="Ex: 5.89" min="0.01" required>
                </div>
                <!-- New Fuel Type Select Input -->
                <div>
                    <label for="fuelType" class="block text-gray-700 text-sm font-bold mb-2">Tipo de Combustível:</label>
                    <select id="fuelType" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                        <option value="">Selecione o tipo</option>
                        <option value="Etanol">Etanol</option>
                        <option value="Gasolina">Gasolina</option>
                        <option value="Gasolina Aditivada">Gasolina Aditivada</option>
                    </select>
                </div>
                <div class="md:col-span-2 flex justify-center mt-4">
                    <button type="submit" id="submitButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 ease-in-out shadow-md">
                        Adicionar Registro
                    </button>
                </div>
            </form>
        </div>

        <!-- Records Table Section -->
        <div class="overflow-x-auto mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Meus Registros</h2>
            <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-md">
                <thead>
                    <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left">Data</th>
                        <th class="py-3 px-6 text-left">Hodômetro (km)</th>
                        <th class="py-3 px-6 text-left">Litros</th>
                        <th class="py-3 px-6 text-left">R$/Litro</th>
                        <th class="py-3 px-6 text-left">Custo Total (R$)</th>
                        <th class="py-3 px-6 text-left">Consumo (km/L)</th>
                        <th class="py-3 px-6 text-left">Combustível</th> <!-- New column header -->
                        <th class="py-3 px-6 text-left">Ações</th>
                    </tr>
                </thead>
                <tbody id="fuelTableBody" class="text-gray-700 text-sm font-light">
                    <!-- Fuel records will be inserted here by JavaScript -->
                </tbody>
            </table>
            <p id="noRecordsMessage" class="text-gray-500 text-center py-4">Nenhum registro ainda. Adicione um para começar!</p>
        </div>

        <!-- Summary Section -->
        <div class="bg-green-50 rounded-lg shadow-inner p-6">
            <h2 class="text-2xl font-semibold text-green-800 mb-4">Resumo Geral</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <p class="text-gray-700 font-bold">Consumo Médio (km/L): <span id="avgConsumption" class="font-normal text-lg text-green-700">--</span></p>
                </div>
                <div>
                    <p class="text-gray-700 font-bold">Custo Total Registrado (R$): <span id="totalCost" class="font-normal text-lg text-green-700">--</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Box HTML -->
    <div id="messageBox" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg text-center max-w-sm w-full mx-4">
            <p id="messageBoxText" class="text-gray-800 text-lg mb-4"></p>
            <button id="messageBoxClose" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">OK</button>
        </div>
    </div>


    <script>
        // Get references to DOM elements
        const fuelForm = document.getElementById('fuelForm');
        const dateInput = document.getElementById('date');
        const odometerInput = document.getElementById('odometer');
        const litersInput = document.getElementById('liters');
        const priceInput = document.getElementById('price');
        const fuelTypeInput = document.getElementById('fuelType'); // New: Fuel Type input
        const submitButton = document.getElementById('submitButton');
        const fuelTableBody = document.getElementById('fuelTableBody');
        const avgConsumptionSpan = document.getElementById('avgConsumption');
        const totalCostSpan = document.getElementById('totalCost');
        const noRecordsMessage = document.getElementById('noRecordsMessage');

        const messageBox = document.getElementById('messageBox');
        const messageBoxText = document.getElementById('messageBoxText');
        const messageBoxClose = document.getElementById('messageBoxClose');

        // Array to store fuel records
        let fuelRecords = [];
        let editingIndex = null; // To keep track of the record being edited

        // Function to show custom message box
        function showMessageBox(message) {
            messageBoxText.textContent = message;
            messageBox.classList.remove('hidden');
        }

        // Event listener for message box close button
        messageBoxClose.addEventListener('click', () => {
            messageBox.classList.add('hidden');
            // Re-add the single "OK" button for general messages
            const messageBoxButtons = messageBox.querySelector('.p-6');
            messageBoxButtons.innerHTML = ''; // Clear existing content
            messageBoxButtons.appendChild(messageBoxText); // Re-add the text
            const okButton = document.createElement('button');
            okButton.id = 'messageBoxClose'; // Ensure it has the correct ID
            okButton.textContent = 'OK';
            okButton.classList.add('bg-blue-600', 'hover:bg-blue-700', 'text-white', 'font-bold', 'py-2', 'px-4', 'rounded-lg', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-500');
            messageBoxButtons.appendChild(okButton);
            okButton.addEventListener('click', () => messageBox.classList.add('hidden')); // Add back listener
        });


        // Function to save records to localStorage
        function saveRecords() {
            localStorage.setItem('fuelRecords', JSON.stringify(fuelRecords));
        }

        // Function to load records from localStorage
        function loadRecords() {
            const storedRecords = localStorage.getItem('fuelRecords');
            if (storedRecords) {
                fuelRecords = JSON.parse(storedRecords);
            }
        }

        // Function to calculate fuel consumption (km/L)
        function calculateConsumption(prevOdometer, currentOdometer, liters) {
            if (prevOdometer === null || liters === 0) {
                return null; // Cannot calculate for the first record or if liters are zero
            }
            const distance = currentOdometer - prevOdometer;
            return distance / liters;
        }

        // Function to render fuel records in the table and update summary
        function renderRecords() {
            fuelTableBody.innerHTML = ''; // Clear existing records
            if (fuelRecords.length === 0) {
                noRecordsMessage.classList.remove('hidden');
            } else {
                noRecordsMessage.classList.add('hidden');
                let totalLiters = 0;
                let totalCost = 0;
                let totalDistance = 0;

                // Sort records by odometer to ensure correct consumption calculation
                fuelRecords.sort((a, b) => a.odometer - b.odometer);

                fuelRecords.forEach((record, index) => {
                    const row = fuelTableBody.insertRow();
                    row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-50');

                    // Format date for display
                    const formattedDate = new Date(record.date).toLocaleDateString('pt-BR');

                    // Calculate total cost for the record
                    const recordTotalCost = (record.liters * record.price).toFixed(2);

                    // Calculate consumption (km/L) for the current record
                    let consumption = null;
                    if (index > 0) {
                        const prevRecord = fuelRecords[index - 1];
                        consumption = calculateConsumption(prevRecord.odometer, record.odometer, record.liters);
                        if (consumption !== null) {
                            totalDistance += (record.odometer - prevRecord.odometer);
                            totalLiters += record.liters;
                        }
                    }

                    // Insert cells and set content
                    row.insertCell(0).textContent = formattedDate;
                    row.insertCell(1).textContent = record.odometer.toFixed(0);
                    row.insertCell(2).textContent = record.liters.toFixed(2);
                    row.insertCell(3).textContent = record.price.toFixed(2);
                    row.insertCell(4).textContent = recordTotalCost;
                    row.insertCell(5).textContent = consumption !== null ? consumption.toFixed(2) : '-';
                    row.insertCell(6).textContent = record.fuelType || '-'; // New: Display fuel type

                    // Add action buttons (Edit and Delete)
                    const actionsCell = row.insertCell(7); // Adjusted index for new column
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Editar';
                    editButton.classList.add('action-button', 'edit-button', 'mr-2');
                    editButton.onclick = () => editRecord(index);
                    actionsCell.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Excluir';
                    deleteButton.classList.add('action-button', 'delete-button');
                    deleteButton.onclick = () => deleteRecord(index);
                    actionsCell.appendChild(deleteButton);

                    totalCost += parseFloat(recordTotalCost);
                });

                // Calculate overall average consumption
                const totalCalculatedKm = fuelRecords.length > 1 ? fuelRecords[fuelRecords.length - 1].odometer - fuelRecords[0].odometer : 0;
                const totalCalculatedLiters = fuelRecords.reduce((sum, record) => sum + record.liters, 0);
                const actualOverallAvgConsumption = totalCalculatedLiters > 0 ? totalCalculatedKm / totalCalculatedLiters : 0;

                // Update summary section
                avgConsumptionSpan.textContent = actualOverallAvgConsumption.toFixed(2) + ' km/L';
                totalCostSpan.textContent = 'R$ ' + totalCost.toFixed(2);
            }
        }

        // Function to edit a record
        function editRecord(index) {
            editingIndex = index;
            const recordToEdit = fuelRecords[index];

            // Populate the form fields with the record's data
            dateInput.value = recordToEdit.date;
            odometerInput.value = recordToEdit.odometer;
            litersInput.value = recordToEdit.liters;
            priceInput.value = recordToEdit.price;
            fuelTypeInput.value = recordToEdit.fuelType || ''; // New: Set fuel type

            // Change the submit button text
            submitButton.textContent = 'Atualizar Registro';
            submitButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            submitButton.classList.add('bg-green-600', 'hover:bg-green-700');
        }

        // Function to delete a record
        async function deleteRecord(index) {
            const confirmed = await window.confirm('Tem certeza que deseja excluir este registro?');
            if (confirmed) {
                fuelRecords.splice(index, 1); // Remove the record from the array
                saveRecords(); // Save changes to localStorage
                renderRecords(); // Re-render the table
                showMessageBox('Registro excluído com sucesso!');
            }
        }

        // Override default confirm with custom message box for deletion
        window.confirm = function(message) {
            // Display custom message box with OK and Cancel buttons
            messageBoxText.textContent = message;
            messageBox.classList.remove('hidden');

            return new Promise((resolve) => {
                const okButton = document.createElement('button');
                okButton.textContent = 'Sim';
                okButton.classList.add('bg-red-600', 'hover:bg-red-700', 'text-white', 'font-bold', 'py-2', 'px-4', 'rounded-lg', 'focus:outline-none', 'focus:ring-2', 'focus:ring-red-500', 'mr-2');
                okButton.onclick = () => {
                    messageBox.classList.add('hidden');
                    resolve(true);
                    // Remove buttons after action
                    okButton.remove();
                    cancelButton.remove();
                };

                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Não';
                cancelButton.classList.add('bg-gray-400', 'hover:bg-gray-500', 'text-white', 'font-bold', 'py-2', 'px-4', 'rounded-lg', 'focus:outline-none', 'focus:ring-2', 'focus:ring-gray-500');
                cancelButton.onclick = () => {
                    messageBox.classList.add('hidden');
                    resolve(false);
                    // Remove buttons after action
                    okButton.remove();
                    cancelButton.remove();
                };

                // Clear previous buttons and add new ones for confirmation
                const messageBoxButtonsContainer = messageBox.querySelector('.p-6');
                // Ensure the messageBoxText is still present if it was re-added.
                // Re-add it just in case if it's missing, but it should typically be there.
                if (!messageBoxButtonsContainer.contains(messageBoxText)) {
                    messageBoxButtonsContainer.prepend(messageBoxText);
                }
                // Remove existing OK button if it's there from a previous showMessageBox call
                const existingOkButton = messageBoxButtonsContainer.querySelector('#messageBoxClose');
                if (existingOkButton) {
                    existingOkButton.remove();
                }

                messageBoxButtonsContainer.appendChild(okButton);
                messageBoxButtonsContainer.appendChild(cancelButton);
            });
        };


        // Event listener for form submission
        fuelForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevent default form submission

            // Get input values
            const date = dateInput.value;
            const odometer = parseFloat(odometerInput.value);
            const liters = parseFloat(litersInput.value);
            const price = parseFloat(priceInput.value);
            const fuelType = fuelTypeInput.value; // New: Get fuel type

            // Basic validation
            if (isNaN(odometer) || isNaN(liters) || isNaN(price) || odometer < 0 || liters <= 0 || price <= 0 || !fuelType) {
                showMessageBox('Por favor, preencha todos os campos, incluindo o tipo de combustível, com valores válidos (números positivos para hodômetro, litros e preço).');
                return;
            }

            // Check if odometer reading is greater than the last one (if any)
            if (editingIndex === null && fuelRecords.length > 0) { // Only check for new records
                const lastOdometer = fuelRecords.reduce((max, record) => Math.max(max, record.odometer), 0);
                if (odometer <= lastOdometer) {
                    showMessageBox('O hodômetro atual (' + odometer.toFixed(0) + ' km) deve ser maior que o último registro (' + lastOdometer.toFixed(0) + ' km).');
                    return;
                }
            } else if (editingIndex !== null) { // If editing, ensure the new odometer is still valid relative to its neighbors
                // Create a temporary array excluding the current editing record to check against
                const tempRecords = fuelRecords.filter((_, idx) => idx !== editingIndex);
                const sortedTempRecords = [...tempRecords].sort((a, b) => a.odometer - b.odometer);

                let isValidOdometer = true;
                // Check if the edited odometer is between its potential new neighbors
                for (let i = 0; i < sortedTempRecords.length; i++) {
                    if (odometer < sortedTempRecords[i].odometer) {
                        if (i > 0 && odometer < sortedTempRecords[i-1].odometer) {
                            isValidOdometer = false;
                            break;
                        }
                    } else if (odometer === sortedTempRecords[i].odometer) {
                        isValidOdometer = false; // Cannot have duplicate odometers
                        break;
                    }
                }

                if (!isValidOdometer) {
                    showMessageBox('O hodômetro atual deve ser maior que o registro anterior e menor que o próximo registro (se houver).');
                    return;
                }
            }


            // Create or update record object
            const newRecord = {
                date: date,
                odometer: odometer,
                liters: liters,
                price: price,
                fuelType: fuelType // New: Add fuel type to the record
            };

            if (editingIndex !== null) {
                // Update existing record
                fuelRecords[editingIndex] = newRecord;
                showMessageBox('Registro atualizado com sucesso!');
                editingIndex = null; // Reset editing state
                submitButton.textContent = 'Adicionar Registro'; // Reset button text
                submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else {
                // Add new record
                fuelRecords.push(newRecord);
                showMessageBox('Registro adicionado com sucesso!');
            }

            saveRecords(); // Save changes to localStorage
            renderRecords(); // Re-render the records and update summary

            // Clear the form fields
            fuelForm.reset();
            fuelTypeInput.value = ""; // Reset fuel type combobox
        });

        // Initial load and render on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadRecords();
            renderRecords();
        });
    </script>
</body>
</html>
